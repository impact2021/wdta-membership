<?php
/**
 * Admin settings template
 */

if (!defined('ABSPATH')) {
    exit;
}

$all_pages = get_pages();
$restricted_pages = get_option('wdta_restricted_pages', array());
?>

<div class="wrap">
    <h1>WDTA Membership Settings</h1>
    
    <?php settings_errors('wdta_settings'); ?>
    
    <form method="post" action="">
        <?php wp_nonce_field('wdta_settings_action', 'wdta_settings_nonce'); ?>
        
        <h2>Stripe Payment Settings</h2>
        <table class="form-table">
            <tr>
                <th scope="row"><label for="wdta_stripe_public_key">Stripe Publishable Key</label></th>
                <td>
                    <input type="text" id="wdta_stripe_public_key" name="wdta_stripe_public_key" 
                           value="<?php echo esc_attr(get_option('wdta_stripe_public_key')); ?>" 
                           class="regular-text">
                    <p class="description">Your Stripe publishable key (starts with pk_)</p>
                </td>
            </tr>
            <tr>
                <th scope="row"><label for="wdta_stripe_secret_key">Stripe Secret Key</label></th>
                <td>
                    <input type="text" id="wdta_stripe_secret_key" name="wdta_stripe_secret_key" 
                           value="<?php echo esc_attr(get_option('wdta_stripe_secret_key')); ?>" 
                           class="regular-text">
                    <p class="description">Your Stripe secret key (starts with sk_)</p>
                </td>
            </tr>
            <tr>
                <th scope="row"><label for="wdta_stripe_webhook_secret">Stripe Webhook Secret</label></th>
                <td>
                    <input type="text" id="wdta_stripe_webhook_secret" name="wdta_stripe_webhook_secret" 
                           value="<?php echo esc_attr(get_option('wdta_stripe_webhook_secret')); ?>" 
                           class="regular-text">
                    <p class="description">Your Stripe webhook signing secret (starts with whsec_)</p>
                    <p class="description">Webhook URL: <code><?php echo rest_url('wdta/v1/stripe-webhook'); ?></code></p>
                </td>
            </tr>
        </table>
        
        <h2>Bank Transfer Settings</h2>
        <table class="form-table">
            <tr>
                <th scope="row"><label for="wdta_bank_name">Bank Name</label></th>
                <td>
                    <input type="text" id="wdta_bank_name" name="wdta_bank_name" 
                           value="<?php echo esc_attr(get_option('wdta_bank_name')); ?>" 
                           class="regular-text">
                </td>
            </tr>
            <tr>
                <th scope="row"><label for="wdta_bank_account_name">Account Name</label></th>
                <td>
                    <input type="text" id="wdta_bank_account_name" name="wdta_bank_account_name" 
                           value="<?php echo esc_attr(get_option('wdta_bank_account_name')); ?>" 
                           class="regular-text">
                </td>
            </tr>
            <tr>
                <th scope="row"><label for="wdta_bank_bsb">BSB</label></th>
                <td>
                    <input type="text" id="wdta_bank_bsb" name="wdta_bank_bsb" 
                           value="<?php echo esc_attr(get_option('wdta_bank_bsb')); ?>" 
                           class="regular-text">
                </td>
            </tr>
            <tr>
                <th scope="row"><label for="wdta_bank_account_number">Account Number</label></th>
                <td>
                    <input type="text" id="wdta_bank_account_number" name="wdta_bank_account_number" 
                           value="<?php echo esc_attr(get_option('wdta_bank_account_number')); ?>" 
                           class="regular-text">
                </td>
            </tr>
        </table>
        
        <h2>Access Control</h2>
        <table class="form-table">
            <tr>
                <th scope="row"><label>Restricted Pages</label></th>
                <td>
                    <p class="description">Select pages that require active membership to access:</p>
                    <?php foreach ($all_pages as $page): ?>
                        <label style="display: block; margin: 5px 0;">
                            <input type="checkbox" name="wdta_restricted_pages[]" 
                                   value="<?php echo esc_attr($page->ID); ?>"
                                   <?php checked(in_array($page->ID, $restricted_pages)); ?>>
                            <?php echo esc_html($page->post_title); ?>
                        </label>
                    <?php endforeach; ?>
                </td>
            </tr>
            <tr>
                <th scope="row"><label for="wdta_access_denied_page">Access Denied Page</label></th>
                <td>
                    <select name="wdta_access_denied_page" id="wdta_access_denied_page">
                        <option value="">Default Message</option>
                        <?php foreach ($all_pages as $page): ?>
                            <option value="<?php echo esc_attr($page->ID); ?>" 
                                    <?php selected(get_option('wdta_access_denied_page'), $page->ID); ?>>
                                <?php echo esc_html($page->post_title); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                    <p class="description">Optional: Custom page to redirect users without access</p>
                </td>
            </tr>
        </table>
        
        <h2>Email Templates</h2>
        <p class="description">Customize the email messages sent to members. Available placeholders: {user_name}, {user_email}, {year}, {amount}, {deadline}, {renewal_url}, {site_name}</p>
        
        <table class="form-table">
            <tr>
                <th scope="row"><label for="wdta_email_reminder_1month">1 Month Before (Dec 1st)</label></th>
                <td>
                    <input type="text" id="wdta_email_reminder_1month_subject" name="wdta_email_reminder_1month_subject" 
                           value="<?php echo esc_attr(get_option('wdta_email_reminder_1month_subject', 'WDTA Membership Renewal - Due January 1st')); ?>" 
                           class="large-text" placeholder="Email Subject">
                    <br><br>
                    <?php 
                    wp_editor(
                        get_option('wdta_email_reminder_1month', 
'Dear {user_name},

This is a reminder that your WDTA membership for {year} will be due on January 1st, {year}.

The annual membership fee is ${amount} AUD and must be paid by {deadline}.

You can renew your membership at: {renewal_url}

Best regards,
WDTA Team'),
                        'wdta_email_reminder_1month',
                        array(
                            'textarea_rows' => 10,
                            'media_buttons' => false,
                            'teeny' => false,
                            'tinymce' => array(
                                'toolbar1' => 'bold,italic,underline,link,bullist,numlist,alignleft,aligncenter,alignright',
                            ),
                        )
                    );
                    ?>
                </td>
            </tr>
            
            <tr>
                <th scope="row"><label for="wdta_email_reminder_1week">1 Week Before (Dec 25th)</label></th>
                <td>
                    <input type="text" id="wdta_email_reminder_1week_subject" name="wdta_email_reminder_1week_subject" 
                           value="<?php echo esc_attr(get_option('wdta_email_reminder_1week_subject', 'WDTA Membership - Due in 1 Week')); ?>" 
                           class="large-text" placeholder="Email Subject">
                    <br><br>
                    <?php 
                    wp_editor(
                        get_option('wdta_email_reminder_1week', 
'Dear {user_name},

Your WDTA membership renewal is due in one week (January 1st, {year}).

Please ensure your payment of ${amount} AUD is made by {deadline}.

Renew now at: {renewal_url}

Best regards,
WDTA Team'),
                        'wdta_email_reminder_1week',
                        array(
                            'textarea_rows' => 10,
                            'media_buttons' => false,
                            'teeny' => false,
                            'tinymce' => array(
                                'toolbar1' => 'bold,italic,underline,link,bullist,numlist,alignleft,aligncenter,alignright',
                            ),
                        )
                    );
                    ?>
                </td>
            </tr>
            
            <tr>
                <th scope="row"><label for="wdta_email_reminder_1day">1 Day Before (Dec 31st)</label></th>
                <td>
                    <input type="text" id="wdta_email_reminder_1day_subject" name="wdta_email_reminder_1day_subject" 
                           value="<?php echo esc_attr(get_option('wdta_email_reminder_1day_subject', 'WDTA Membership - Due Tomorrow')); ?>" 
                           class="large-text" placeholder="Email Subject">
                    <br><br>
                    <?php 
                    wp_editor(
                        get_option('wdta_email_reminder_1day', 
'Dear {user_name},

Final reminder: Your WDTA membership for {year} is due tomorrow!

Payment deadline: {deadline}
Amount: ${amount} AUD

Renew immediately at: {renewal_url}

Best regards,
WDTA Team'),
                        'wdta_email_reminder_1day',
                        array(
                            'textarea_rows' => 10,
                            'media_buttons' => false,
                            'teeny' => false,
                            'tinymce' => array(
                                'toolbar1' => 'bold,italic,underline,link,bullist,numlist,alignleft,aligncenter,alignright',
                            ),
                        )
                    );
                    ?>
                </td>
            </tr>
            
            <tr>
                <th scope="row"><label for="wdta_email_overdue_1day">1 Day Overdue (Jan 2nd)</label></th>
                <td>
                    <input type="text" id="wdta_email_overdue_1day_subject" name="wdta_email_overdue_1day_subject" 
                           value="<?php echo esc_attr(get_option('wdta_email_overdue_1day_subject', 'WDTA Membership - Payment Overdue')); ?>" 
                           class="large-text" placeholder="Email Subject">
                    <br><br>
                    <?php 
                    wp_editor(
                        get_option('wdta_email_overdue_1day', 
'Dear {user_name},

Your WDTA membership payment for {year} is now overdue.

To maintain access to member resources, please complete your payment of ${amount} AUD as soon as possible.

Final deadline: {deadline}

Pay now at: {renewal_url}

Best regards,
WDTA Team'),
                        'wdta_email_overdue_1day',
                        array(
                            'textarea_rows' => 10,
                            'media_buttons' => false,
                            'teeny' => false,
                            'tinymce' => array(
                                'toolbar1' => 'bold,italic,underline,link,bullist,numlist,alignleft,aligncenter,alignright',
                            ),
                        )
                    );
                    ?>
                </td>
            </tr>
            
            <tr>
                <th scope="row"><label for="wdta_email_overdue_1week">1 Week Overdue (Jan 8th)</label></th>
                <td>
                    <input type="text" id="wdta_email_overdue_1week_subject" name="wdta_email_overdue_1week_subject" 
                           value="<?php echo esc_attr(get_option('wdta_email_overdue_1week_subject', 'WDTA Membership - Urgent: Payment Required')); ?>" 
                           class="large-text" placeholder="Email Subject">
                    <br><br>
                    <?php 
                    wp_editor(
                        get_option('wdta_email_overdue_1week', 
'Dear {user_name},

URGENT: Your WDTA membership payment for {year} is now one week overdue.

Amount due: ${amount} AUD
Final deadline: {deadline}

Please act now to avoid losing access: {renewal_url}

Best regards,
WDTA Team'),
                        'wdta_email_overdue_1week',
                        array(
                            'textarea_rows' => 10,
                            'media_buttons' => false,
                            'teeny' => false,
                            'tinymce' => array(
                                'toolbar1' => 'bold,italic,underline,link,bullist,numlist,alignleft,aligncenter,alignright',
                            ),
                        )
                    );
                    ?>
                </td>
            </tr>
            
            <tr>
                <th scope="row"><label for="wdta_email_overdue_end_jan">End of January (Jan 31st)</label></th>
                <td>
                    <input type="text" id="wdta_email_overdue_end_jan_subject" name="wdta_email_overdue_end_jan_subject" 
                           value="<?php echo esc_attr(get_option('wdta_email_overdue_end_jan_subject', 'WDTA Membership - 2 Months Until Access Revoked')); ?>" 
                           class="large-text" placeholder="Email Subject">
                    <br><br>
                    <?php 
                    wp_editor(
                        get_option('wdta_email_overdue_end_jan', 
'Dear {user_name},

Your WDTA membership payment for {year} remains outstanding.

You have until {deadline} to complete payment to maintain access.

Amount: ${amount} AUD
Pay at: {renewal_url}

Best regards,
WDTA Team'),
                        'wdta_email_overdue_end_jan',
                        array(
                            'textarea_rows' => 10,
                            'media_buttons' => false,
                            'teeny' => false,
                            'tinymce' => array(
                                'toolbar1' => 'bold,italic,underline,link,bullist,numlist,alignleft,aligncenter,alignright',
                            ),
                        )
                    );
                    ?>
                </td>
            </tr>
            
            <tr>
                <th scope="row"><label for="wdta_email_overdue_end_feb">End of February (Feb 28/29th)</label></th>
                <td>
                    <input type="text" id="wdta_email_overdue_end_feb_subject" name="wdta_email_overdue_end_feb_subject" 
                           value="<?php echo esc_attr(get_option('wdta_email_overdue_end_feb_subject', 'WDTA Membership - Final Month to Pay')); ?>" 
                           class="large-text" placeholder="Email Subject">
                    <br><br>
                    <?php 
                    wp_editor(
                        get_option('wdta_email_overdue_end_feb', 
'Dear {user_name},

FINAL NOTICE: You have one month remaining to pay your WDTA membership for {year}.

Deadline: {deadline}
Amount: ${amount} AUD

After this date, access to member resources will be revoked.

Pay immediately: {renewal_url}

Best regards,
WDTA Team'),
                        'wdta_email_overdue_end_feb',
                        array(
                            'textarea_rows' => 10,
                            'media_buttons' => false,
                            'teeny' => false,
                            'tinymce' => array(
                                'toolbar1' => 'bold,italic,underline,link,bullist,numlist,alignleft,aligncenter,alignright',
                            ),
                        )
                    );
                    ?>
                </td>
            </tr>
            
            <tr>
                <th scope="row"><label for="wdta_email_overdue_end_mar">End of March (Mar 31st - Final Deadline)</label></th>
                <td>
                    <input type="text" id="wdta_email_overdue_end_mar_subject" name="wdta_email_overdue_end_mar_subject" 
                           value="<?php echo esc_attr(get_option('wdta_email_overdue_end_mar_subject', 'WDTA Membership - FINAL DAY to Pay')); ?>" 
                           class="large-text" placeholder="Email Subject">
                    <br><br>
                    <?php 
                    wp_editor(
                        get_option('wdta_email_overdue_end_mar', 
'Dear {user_name},

THIS IS YOUR FINAL DAY to pay your WDTA membership for {year}.

Today is {deadline} - the absolute final deadline.

Amount: ${amount} AUD
Pay NOW: {renewal_url}

After today, you will lose access to all member resources.

Best regards,
WDTA Team'),
                        'wdta_email_overdue_end_mar',
                        array(
                            'textarea_rows' => 10,
                            'media_buttons' => false,
                            'teeny' => false,
                            'tinymce' => array(
                                'toolbar1' => 'bold,italic,underline,link,bullist,numlist,alignleft,aligncenter,alignright',
                            ),
                        )
                    );
                    ?>
                </td>
            </tr>
        </table>
        
        <?php submit_button('Save Settings', 'primary', 'wdta_settings_submit'); ?>
    </form>
</div>
